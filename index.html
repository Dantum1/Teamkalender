<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Availability â€“ Live</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0b0f14; color:#e7eef7; }
    header { padding:16px 18px; border-bottom:1px solid #1b2735; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    header h1{ margin:0; font-size:16px; font-weight:650; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 18px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .card{ background:#0f1620; border:1px solid #1b2735; border-radius:16px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    .left{ flex: 1 1 720px; }
    .right{ flex: 1 1 360px; position:sticky; top:12px; }
    label{ display:block; font-size:12px; opacity:.85; margin:10px 0 6px; }
    input, select, button { border-radius:12px; border:1px solid #223248; background:#0b111a; color:#e7eef7; padding:10px 12px; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:1px solid #2a3d57; background:#122033; }
    button:hover{ filter:brightness(1.08); }
    .muted{ opacity:.75; font-size:12px; }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .toolbar > * { width:auto; }
    .gridWrap{ overflow:auto; border:1px solid #1b2735; border-radius:14px; background:#0b111a; }
    table{ border-collapse:separate; border-spacing:0; min-width:980px; width:100%; }
    th, td{ border-right:1px solid #152232; border-bottom:1px solid #152232; padding:0; }
    th{ position:sticky; top:0; background:#0f1620; z-index:2; font-size:12px; padding:8px 10px; text-align:left; }
    th:first-child{ left:0; z-index:3; position:sticky; }
    td:first-child{ position:sticky; left:0; background:#0b111a; z-index:1; }
    .hcell{ padding:8px 10px; font-size:12px; opacity:.85; white-space:nowrap; }
    .slot{
      width: 100%;
      height: 28px;
      display:flex; align-items:center; justify-content:center;
      font-size:12px;
      user-select:none;
      cursor:pointer;
    }
    .slot.on{ outline:1px solid #2f6a52; }
    .slot:hover{ filter:brightness(1.1); }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #24344a; background:#0b111a; font-size:12px; }
    .list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .item{ border:1px solid #1b2735; border-radius:14px; padding:10px 12px; background:#0b111a; }
    .item .top{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .ok{ color:#a7ffcd; }
    .warn{ color:#ffd38a; }
    .players{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .pitem{ display:flex; gap:8px; align-items:center; justify-content:space-between; border:1px solid #1b2735; border-radius:14px; padding:10px 12px; background:#0b111a; }
    .pitem b{ font-weight:650; }
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:flex; align-items:center; justify-content:center;
  z-index:999;
}
.modalCard{
  background:#0f1620;
  border:1px solid #1b2735;
  border-radius:16px;
  padding:18px;
  width:320px;
}

.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #24344a;
  background:#0b111a;
  font-size:12px;
}
.chip .dot{
  width:8px; height:8px;
  border-radius:999px;
  background:#6ee7ff;
  opacity:.9;
}


  </style>
</head>
<body>
<div id="nameModal" class="modal" style="display:none;">
  <div class="modalCard">
    <h3>Willkommen ðŸ‘‹</h3>
    <p class="muted">Wie sollen wir dich nennen?</p>
    <input id="modalName" placeholder="Dein Name">
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="modalCancel">Abbrechen</button>
      <button id="modalOk">Beitreten</button>
    </div>
  </div>
</div>

<header>
  <h1>ðŸ§© Team Availability â€“ Live</h1>
  <span class="muted">Erstellen/Beitreten â†’ Slots klicken â†’ alle sehen Updates in Echtzeit</span>
</header>



<div class="wrap">

<div class="tabs">
  <button class="tab active" id="tabHome">TeamÃ¼bersicht</button>
  <button class="tab" id="tabCalendar"><span id="tabCalendarLabel">Kalender</span></button>
  <span class="muted" style="margin-left:auto" id="livePill"></span>
</div>

<section class="card" id="panelHome">
  <h2 style="margin:0 0 10px; font-size:16px;">Teamkalender</h2>

  <!-- âœ… HIER deine bestehende Toolbar REINKOPIEREN -->
  <div class="toolbar" id="homeToolbar">
 
       
	<label style="margin:0;">
  	   <span class="muted">Room</span><br/>
  	   <input id="roomCode" placeholder="TEAM1" style="width:140px; text-transform:uppercase;">
	</label>

        <label style="margin:0;">
          <span class="muted">Join-Code</span><br/>
          <input id="joinCode" placeholder="secret123" style="width:140px;">
        </label>

        <label style="margin:0;">
          <span class="muted">Name</span><br/>
          <input id="myName" placeholder="Leon" style="width:140px;">
        </label>

        <button id="createBtn">Erstellen</button>
        <button id="joinBtn">Beitreten</button>
	<button id="inviteBtn" type="button">Invite-Link kopieren</button>

	

        <span style="width:1px; height:34px; background:#1b2735;"></span>

        <span class="pill">Zeitraum: <b id="rangeLabel"></b></span>

        <label style="margin:0;">
          <span class="muted">Startdatum</span><br/>
          <input id="startDate" type="date">
        </label>

        <label style="margin:0;">
          <span class="muted">Tage</span><br/>
          <select id="daysCount">
            <option>5</option><option selected>7</option><option>10</option><option>14</option>
          </select>
        </label>

        <label style="margin:0;">
          <span class="muted">Von</span><br/>
          <select id="hourFrom"></select>
        </label>

        <label style="margin:0;">
          <span class="muted">Bis</span><br/>
          <select id="hourTo"></select>
        </label>

        <label style="margin:0;">
          <span class="muted">Slot</span><br/>
          <select id="slotMinutes">
            <option value="30">30 min</option>
            <option value="60" selected>60 min</option>
          </select>
        </label>

        <span style="flex:1"></span>

        
  <div class="muted" style="margin-top:12px;">TeamÃ¼bersicht</div>
  <div class="list" id="teamOverview"></div>
</section>

<div id="panelCalendar" style="display:none;">

<div class="card" id="roomHeader" style="display:none; margin-bottom:12px;">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
    <div>
	
      <div class="muted" style="font-size:12px;">Team / Room</div>
      <div id="roomTitle" style="font-weight:700; font-size:18px;">â€“</div>
      <div id="roomMeta" class="muted" style="margin-top:4px;">â€“</div>
    </div>
    <div>
      <button id="inviteBtnTop" type="button">Invite-Link kopieren</button>
    </div>
  </div>

  <div class="muted" style="margin-top:12px;">Mitglieder</div>
  <div id="memberChips" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;"></div>
</div>




  <div class="row">

    <section class="card left">
      

      <div class="muted" style="margin-top:10px;">
        In <b>Ich (klicken)</b> markierst du deine Slots. In <b>Overlap</b> siehst du wie viele kÃ¶nnen.
      </div>


      <div class="gridWrap" style="margin-top:12px;">
        <table id="tbl"></table>
      </div>
    </section>

    <aside class="card right">
       
<div style="display:flex; flex-direction:column; gap:12px;">
  <label style="margin:0;">
    <span class="muted">Ansicht</span><br/>
    <select id="mode">
      <option value="overlay" selected>Overlap (alle)</option>
      <option value="me">Ich (klicken)</option>
    </select>
  </label>

  <div>
    <div style="font-weight:650;">Room Status</div>
    <div class="muted">Mitglieder & VorschlÃ¤ge</div>
  </div>
</div>

              </div>
<div class="players" id="players"></div>
      <hr style="border:none; border-top:1px solid #1b2735; margin:14px 0;">

      <div style="font-weight:650;">Top TerminvorschlÃ¤ge</div>
      <div class="muted">hÃ¶chster Overlap</div>
      <div class="list" id="suggestions"></div>

      <hr style="border:none; border-top:1px solid #1b2735; margin:14px 0;">

      <div id="status" class="muted"></div>
    </aside>
   </div>
 </div>
</div>


  <!-- âœ… Auth-Modal hier einfÃ¼gen -->
  <div id="authModal" class="modal" style="display:none;">
    <div class="modalCard">
      <h3>Login</h3>
      <p class="muted">Melde dich an, damit dein Name gespeichert bleibt.</p>

      <label>E-Mail</label>
      <input id="authEmail" type="email" placeholder="you@company.com">

      <label>Passwort</label>
      <input id="authPw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="authSignup">Registrieren</button>
        <button id="authLogin">Login</button>
      </div>

      <hr style="border:none; border-top:1px solid #1b2735; margin:14px 0;">
      <button id="authLogout" style="width:100%; display:none;">Logout</button>
    </div>
  </div>



<script type="module">

// ===== Name Modal Helper =====
async function askName(){
  return new Promise(res => {
    const m = document.getElementById("nameModal");
    const input = document.getElementById("modalName");
    m.style.display = "flex";
    input.value = "";
    input.focus();

    modalOk.onclick = () => {
      m.style.display = "none";
      res(input.value.trim());
    };
    modalCancel.onclick = () => {
      m.style.display = "none";
      res(null);
    };
  });
}



import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://ipsxbbbdnsufpfbqsqqv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwc3hiYmJkbnN1ZnBmYnFzcXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjUzNTYsImV4cCI6MjA4MTE0MTM1Nn0.JCDyw6e9stz-mQpUp-mqjzet9-NeyofKSYYiD-ZJHJo";

const supabase = createClient(
   SUPABASE_URL,
   SUPABASE_ANON_KEY,
   {
     auth: {
	persistSession: true,
	autoRefreshToken: true,
	detectSessionInUrl: true
      }
    }
);

window.supabase = supabase;


 function notify(msg, kind="") {
  const el = document.getElementById("status");
  if (el) {
    el.textContent = msg;
    el.className = "muted " + kind;
    setTimeout(()=>{ el.textContent=""; el.className="muted"; }, 4500);
  } else {
    alert(msg);
  }
  console.log("[notify]", kind, msg);
}


 let room = "";
  let me = "";
  let myUserId = "";
  let realtimeChannel = null;
  let joining = false;


const authEmail = document.getElementById("authEmail");
const authPw = document.getElementById("authPw");
const authLogin = document.getElementById("authLogin");
const authSignup = document.getElementById("authSignup");
const authLogout = document.getElementById("authLogout");

authLogin.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: authEmail.value.trim(),
    password: authPw.value
  });
  if (error) return notify(`Login: ${error.message}`, "warn");
};

authSignup.onclick = async () => {
  const { error } = await supabase.auth.signUp({
    email: authEmail.value.trim(),
    password: authPw.value
  });
  if (error) return notify(`Signup: ${error.message}`, "warn");
  notify("Registriert âœ… Bitte E-Mail ggf. bestÃ¤tigen.", "ok");
};

authLogout.onclick = async () => {
  await supabase.auth.signOut();
};




  // --- UI / State ---
  const pad = n => String(n).padStart(2,"0");
  const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const addDays = (d, n) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
  const fmtDay = d => d.toLocaleDateString("de-DE",{ weekday:"short", day:"2-digit", month:"2-digit" });
  // --- Persistenter Session-Store (Desktop) ---
  const LS_KEY = "teamAvail:v1";

  function saveSessionPrefs(){
  localStorage.setItem(LS_KEY, JSON.stringify({room }));
}

  function loadSessionPrefs(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch { return {}; }
}

  function forgetSessionPrefs(){
    localStorage.removeItem(LS_KEY);
}

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  const slotKey = (dateStr, hh, mm) => `${dateStr}|${pad(hh)}:${pad(mm)}`;


   // Shared state loaded from DB
  let members = []; // [{user_id, display_name}]
  let availabilityByUser = new Map(); // user_id -> Set(slot_key)

  // UI prefs (local only)
  const now = new Date();
  let ui = {
    startDate: ymd(now),
    daysCount: 7,
    hourFrom: 16,
    hourTo: 24,
    slotMinutes: 60,
    mode: "overlay"
  };

  // Elements
  const startDateEl = document.getElementById("startDate");
  const daysCountEl = document.getElementById("daysCount");
  const hourFromEl = document.getElementById("hourFrom");
  const hourToEl = document.getElementById("hourTo");
  const slotMinutesEl = document.getElementById("slotMinutes");
  const modeEl = document.getElementById("mode");
  const tbl = document.getElementById("tbl");
  const rangeLabel = document.getElementById("rangeLabel");
  const suggestionsEl = document.getElementById("suggestions");
  const playersEl = document.getElementById("players");

// --- Share / Invite ---
function buildInviteLink(){
  const url = new URL(location.href);
  url.searchParams.set("room", room || document.getElementById("roomCode").value.trim().toUpperCase());
  // Join-Code NICHT in URL!
  url.searchParams.delete("join");
  return url.toString();
}

async function copyToClipboard(text){
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    // Fallback fÃ¼r unsichere Kontexte/Ã¤ltere Browser
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  }
}

// Prefill room from ?room=...
(function prefillFromUrl(){
  const params = new URLSearchParams(location.search);
  const r = params.get("room");
  if (r) document.getElementById("roomCode").value = String(r).trim().toUpperCase();
})();





  // init hour selects
  for (let h=0; h<=24; h++){
    const o1 = document.createElement("option"); o1.value=h; o1.textContent=pad(h)+":00";
    const o2 = o1.cloneNode(true);
    hourFromEl.appendChild(o1); hourToEl.appendChild(o2);
  }

  function syncControls(){
    startDateEl.value = ui.startDate;
    daysCountEl.value = String(ui.daysCount);
    hourFromEl.value = String(ui.hourFrom);
    hourToEl.value = String(ui.hourTo);
    slotMinutesEl.value = String(ui.slotMinutes);
    modeEl.value = ui.mode;
  }

  function getDays(){
    const base = new Date(ui.startDate + "T00:00:00");
    const days = [];
    for (let i=0; i<ui.daysCount; i++) days.push(addDays(base,i));
    return days;
  }

  function getTimes(){
    const times = [];
    const from = Number(ui.hourFrom);
    const to = Number(ui.hourTo);
    const step = Number(ui.slotMinutes);
    for (let h=from; h<to; h++){
      for (let m=0; m<60; m+=step){
        times.push([h,m]);
      }
    }
    return times;
  }

  function overlapCount(dateStr,h,m){
    const key = slotKey(dateStr,h,m);
    let c = 0;
    for (const [uid, set] of availabilityByUser.entries()){
      if (set.has(key)) c++;
    }
    return c;
  }

  function myHas(key){
    const set = availabilityByUser.get(myUserId);
    return !!(set && set.has(key));
  }

function parseSlotKey(key){
  // key: "YYYY-MM-DD|HH:MM"
  const [dateStr, timeStr] = key.split("|");
  const [hh, mm] = timeStr.split(":").map(Number);
  return { dateStr, hh, mm };
}

function slotsForUserInCurrentRange(userId){
  const set = availabilityByUser.get(userId) || new Set();

  // gÃ¼ltige keys fÃ¼r aktuellen sichtbaren Bereich
  const valid = new Set();
  for (const d of getDays()){
    const dateStr = ymd(d);
    for (const [h,m] of getTimes()){
      valid.add(slotKey(dateStr, h, m));
    }
  }

  const arr = [];
  for (const key of set){
    if (!valid.has(key)) continue;
    const { dateStr, hh, mm } = parseSlotKey(key);
    arr.push({ key, dateStr, hh, mm });
  }

  arr.sort((a,b) =>
    (a.dateStr.localeCompare(b.dateStr)) ||
    (a.hh - b.hh) ||
    (a.mm - b.mm)
  );

  return arr;
}

function initials(name){
  const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
  const a = (parts[0]?.[0] || "").toUpperCase();
  const b = (parts[1]?.[0] || "").toUpperCase();
  return (a + b) || a || "?";
}

function availableMembersForSlot(dateStr,h,m){
  const key = slotKey(dateStr,h,m);
  const res = [];
  for (const mem of members){
    const set = availabilityByUser.get(mem.user_id);
    if (set && set.has(key)) res.push(mem);
  }
  return res;
}



function renderPlayers(){
  playersEl.innerHTML = "";
  if (!room){
    playersEl.innerHTML = `<div class="muted">Noch nicht verbunden.</div>`;
    return;
  }
  if (!members.length){
    playersEl.innerHTML = `<div class="muted">Keine Members geladen.</div>`;
    return;
  }

  for (const m of members){
    const set = availabilityByUser.get(m.user_id) || new Set();
    const inRange = slotsForUserInCurrentRange(m.user_id);

    const row = document.createElement("div");
    row.className = "pitem";

    // Dropdown (Details)
    const detailsHtml = `
      <details style="margin-top:8px;">
        <summary class="muted" style="cursor:pointer;">Slots anzeigen (${inRange.length} in aktueller Ansicht)</summary>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
          ${inRange.length ? inRange.map(s => {
            const d = new Date(s.dateStr + "T00:00:00");
            return `<div class="muted">${fmtDay(d)} â€¢ ${pad(s.hh)}:${pad(s.mm)}</div>`;
          }).join("") : `<div class="muted">Keine Slots in diesem Zeitraum.</div>`}
        </div>
      </details>
    `;

    row.innerHTML = `
      <div style="width:100%;">
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div>
            <b>${escapeHtml(m.display_name)}</b>
            <div class="muted">${set.size} Slots (gesamt)</div>
          </div>
          <div class="muted">${m.user_id === myUserId ? "du" : ""}</div>
        </div>
        ${detailsHtml}
      </div>
    `;

    playersEl.appendChild(row);
  }
}



  function renderSuggestions(){
    const days = getDays();
    const times = getTimes();
    const candidates = [];

    for (const d of days){
      const dateStr = ymd(d);
      for (const [h,m] of times){
        const c = overlapCount(dateStr,h,m);
        candidates.push({ dateStr, h, m, c });
      }
    }

    candidates.sort((a,b) => b.c - a.c || (a.dateStr+a.h+a.m).localeCompare(b.dateStr+b.h+b.m));
    const top = candidates.filter(x=>x.c>0).slice(0,8);

    suggestionsEl.innerHTML = "";
    if (!top.length){
      suggestionsEl.innerHTML = `<div class="muted">Noch keine Overlaps. Leute sollen Slots markieren.</div>`;
      return;
    }

    for (const s of top){
      const d = new Date(s.dateStr + "T00:00:00");
      const title = `${fmtDay(d)} â€¢ ${pad(s.h)}:${pad(s.m)} (${ui.slotMinutes} min)`;
      const pct = members.length ? Math.round((s.c/members.length)*100) : 0;

      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="top">
          <div>
            <div style="font-weight:650;">${title}</div>
            <div class="muted">${s.c}/${members.length} kÃ¶nnen (${pct}%)</div>
          </div>
        </div>
      `;
      suggestionsEl.appendChild(it);
    }
  }

// âœ… HIER EINFÃœGEN (Schritt 3)
function renderRoomHeader(){
  const header = document.getElementById("roomHeader");
  const title = document.getElementById("roomTitle");
  const meta = document.getElementById("roomMeta");
  const chips = document.getElementById("memberChips");

  if (!header || !title || !meta || !chips) return;

  if (!room){
    header.style.display = "none";
    return;
  }

  header.style.display = "";
  title.textContent = room;
  meta.textContent = `${members.length} Mitglieder`;

  chips.innerHTML = "";
  for (const m of members){
    const el = document.createElement("div");
    el.className = "chip";
    el.innerHTML = `
      <span class="dot"></span>
      <span>${escapeHtml(m.display_name)}${m.user_id === myUserId ? " (du)" : ""}</span>
    `;
    chips.appendChild(el);
  }
}

function renderTabLabels(){
  const el = document.getElementById("tabCalendarLabel");
  if (!el) return;

  el.textContent = room ? room : "Kalender";
}

  function renderTable(){
    const days = getDays();
    const times = getTimes();

    const start = days[0], end = days[days.length-1];
    rangeLabel.textContent = `${fmtDay(start)} â€“ ${fmtDay(end)}`;

    tbl.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `<th>Uhrzeit</th>` + days.map(d=>`<th>${fmtDay(d)}</th>`).join("");
    tbl.appendChild(trh);

    for (const [h,m] of times){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="hcell">${pad(h)}:${pad(m)}</td>`;

      for (const d of days){
        const dateStr = ymd(d);
        const key = slotKey(dateStr,h,m);

        const td = document.createElement("td");
        const div = document.createElement("div");
        div.className="slot";

        if (ui.mode === "me"){
          const on = myHas(key);
          div.classList.toggle("on", on);
          div.textContent = on ? "âœ“" : "";
          div.style.background = on ? "rgba(34, 187, 119, 0.14)" : "transparent";
          div.onclick = () => toggleSlot(key);
       } else {
  const avail = availableMembersForSlot(dateStr,h,m);
  const c = avail.length;

  if (c){
    const names = avail.map(x => x.display_name);
    const short = avail.slice(0,3).map(x => initials(x.display_name)).join(" ");
    const more = c > 3 ? ` +${c-3}` : "";

    div.innerHTML = `
      <div style="display:flex; flex-direction:column; line-height:1; gap:4px; align-items:center;">
        <div style="font-weight:650;">${c}</div>
        <div class="muted" style="font-size:11px;">${short}${more}</div>
      </div>
    `;
    div.title = names.join(", ");
  } else {
    div.textContent = "";
    div.title = "";
  }

  const ratio = members.length ? c/members.length : 0;
  div.style.background = ratio ? `rgba(120, 170, 255, ${0.08 + ratio*0.38})` : "transparent";
  div.onclick = () => notify("Wechsle auf 'Ich (klicken)' um Slots zu setzen.", "warn");
}


        td.appendChild(div);
        tr.appendChild(td);
      }
      tbl.appendChild(tr);
    }
  }

  function renderAll(){
    syncControls();
    renderPlayers();
    renderSuggestions();
    renderRoomHeader();
    renderTabLabels();
    renderTable();
  }

async function ensureSignedIn() {
  console.log("[ensureSignedIn] start");

  const { data: { session }, error } = await supabase.auth.getSession();

  console.log("[ensureSignedIn] getSession:", { hasSession: !!session, error });

  if (error) throw error;

  if (session?.user) {
    myUserId = session.user.id;
    console.log("[ensureSignedIn] OK userId:", myUserId);
    return session.user;
  }

  console.warn("[ensureSignedIn] NOT signed in -> showAuth()");
  showAuth();
  throw new Error("Not signed in");
}


function showAuth(){
  const m = document.getElementById("authModal");
  if (!m) {
    console.error("[showAuth] authModal not found in DOM");
    return;
  }
  m.style.display = "flex";
}

function hideAuth(){
  const m = document.getElementById("authModal");
  if (!m) return;
  m.style.display = "none";
}


async function loadMyProfile(user){
  const { data, error } = await supabase
    .from("profiles")
    .select("display_name")
    .eq("id", user.id)
    .single();

  if (error) throw error;

  let displayName = (data?.display_name || "").trim();

  // wenn noch kein Name gesetzt: einmalig abfragen und speichern
  if (!displayName) {
    const asked = await askName();
    if (!asked) throw new Error("No display name provided");
    displayName = asked.trim();

    const { error: upErr } = await supabase
      .from("profiles")
      .update({ display_name: displayName })
      .eq("id", user.id);

    if (upErr) throw upErr;
  }

  me = displayName;
  // optional: Feld anzeigen (read-only) statt Pflichtfeld
  const myNameEl = document.getElementById("myName");
  if (myNameEl) {
    myNameEl.value = displayName;
    myNameEl.disabled = true;
  }

  return displayName;
}


  async function loadRoomState(){
    // Members
    const { data: mem, error: meErr } = await supabase
      .from("room_members")
      .select("user_id, display_name")
      .eq("room_code", room);

    if (meErr){ console.error(meErr); notify("Members laden fehlgeschlagen", "warn"); return; }
    members = mem || [];

    // Availability
    const { data: slots, error: slErr } = await supabase
      .from("availability")
      .select("user_id, slot_key")
      .eq("room_code", room);

    if (slErr){ console.error(slErr); notify("Slots laden fehlgeschlagen", "warn"); return; }

    const map = new Map();
    for (const row of (slots || [])){
      if (!map.has(row.user_id)) map.set(row.user_id, new Set());
      map.get(row.user_id).add(row.slot_key);
    }
    availabilityByUser = map;
  }

  async function startRealtime(){
    if (realtimeChannel){
      await supabase.removeChannel(realtimeChannel);
      realtimeChannel = null;
    }

    realtimeChannel = supabase
      .channel(`room:${room}`)
      .on("postgres_changes",
        { event:"*", schema:"public", table:"availability", filter:`room_code=eq.${room}` },
        async () => { await loadRoomState(); renderAll(); }
      )
      .on("postgres_changes",
        { event:"*", schema:"public", table:"room_members", filter:`room_code=eq.${room}` },
        async () => { await loadRoomState(); renderAll(); }
      )
      .subscribe();
  }


// Optional: fÃ¼rs Debuggen im DevTools global verfÃ¼gbar machen
// (weil type="module" sonst nicht im Console-Scope ist)
function exposeDebugFns(obj){
  try { Object.assign(window, obj); } catch {}
}

// âœ… Einmalige Helper-Funktion: Auth + Profil sicherstellen
async function requireAuthAndProfile() {
  const { data: { session }, error } = await supabase.auth.getSession();
  if (error) {
    console.error("[auth] getSession error", error);
    notify(`Auth Fehler: ${error.message}`, "warn");
    return null;
  }

  if (!session?.user) {
    showAuth();
    notify("Bitte zuerst einloggen.", "warn");
    return null;
  }

  myUserId = session.user.id;

  try {
    await loadMyProfile(session.user); // setzt "me"
  } catch (e) {
    console.error("[auth] loadMyProfile failed", e);
    notify("Profil konnte nicht geladen werden (siehe Konsole).", "warn");
    return null;
  }

  return session.user;
}


async function createRoom() {
  if (joining) return;
  joining = true;

  try {
    const user = await ensureSignedIn();
    await loadMyProfile(user);

    const roomInput = document.getElementById("roomCode");
    const joinInput = document.getElementById("joinCode");

    room = roomInput.value.trim().toUpperCase();
    const joinCode = joinInput.value.trim();

    if (!room || !joinCode) {
      notify("Bitte Room + Join-Code eingeben.", "warn");
      return;
    }

    const { error } = await supabase.rpc("create_room", {
      p_room: room,
      p_join_code: joinCode,
      p_display_name: me
    });

    if (error) throw error;

    await loadRoomState();
    await startRealtime();
    renderAll();

    notify("Room erstellt âœ…", "ok");
  } catch (e) {
    console.error(e);
    notify(e.message, "warn");
  } finally {
    joining = false;
  }
}

async function joinRoom() {
  if (joining) return;
  joining = true;

  try {
    const user = await ensureSignedIn();
    await loadMyProfile(user);

    const roomInput = document.getElementById("roomCode");
    const joinInput = document.getElementById("joinCode");

    room = roomInput.value.trim().toUpperCase();
    const joinCode = joinInput.value.trim();

    if (!room || !joinCode) {
      notify("Bitte Room + Join-Code eingeben.", "warn");
      return;
    }

    const { error } = await supabase.rpc("join_room", {
      p_room: room,
      p_join_code: joinCode,
      p_display_name: me
    });

    if (error) throw error;

    await loadRoomState();
    await startRealtime();
    renderAll();

    notify("Beigetreten âœ…", "ok");
  } catch (e) {
    console.error(e);
    notify(e.message, "warn");
  } finally {
    joining = false;
  }
}

// FÃ¼r Debug in Console:
Object.assign(window, { createRoom, joinRoom });


window.createRoom = createRoom;
window.joinRoom = joinRoom;



// optional fÃ¼rs Debuggen:
exposeDebugFns({ createRoom, joinRoom });


  // --- Actions ---



  async function toggleSlot(key){
    if (!room) return notify("Bitte zuerst Erstellen oder Beitreten.", "warn");
    if (!myUserId) return notify("Nicht eingeloggt (anon auth).", "warn");

    const isOn = myHas(key);

    if (!isOn){
      const { error } = await supabase
        .from("availability")
        .upsert({ room_code: room, user_id: myUserId, slot_key: key });

      if (error){ console.error(error); return notify("Speichern fehlgeschlagen (RLS?).", "warn"); }
    } else {
      const { error } = await supabase
        .from("availability")
        .delete()
        .match({ room_code: room, user_id: myUserId, slot_key: key });

      if (error){ console.error(error); return notify("LÃ¶schen fehlgeschlagen (RLS?).", "warn"); }
    }
    // Realtime lÃ¤dt dann neu

       await loadRoomState();
       renderAll();
  }

 // --- Wiring ---
const createBtn = document.getElementById("createBtn");
const joinBtn = document.getElementById("joinBtn");

if (!createBtn || !joinBtn) {
  console.error("Buttons nicht gefunden", { createBtn, joinBtn });
} else {
  createBtn.addEventListener("click", async (ev) => {
    ev.preventDefault();
    console.log("createBtn clicked");
    try { await createRoom(); }
    catch (e) { console.error("createRoom failed:", e); }
  });

  joinBtn.addEventListener("click", async (ev) => {
    ev.preventDefault();
    console.log("joinBtn clicked");
    try { await joinRoom(); }
    catch (e) { console.error("joinRoom failed:", e); }
  });
}
// ðŸ”— Invite-Link Button
const inviteBtn = document.getElementById("inviteBtn");
if (inviteBtn){
  inviteBtn.onclick = async () => {
    if (!room) return notify("Erst Room erstellen oder beitreten.", "warn");

    const { data: token, error } = await supabase.rpc("create_invite", {
      p_room: room,
      p_hours: 72
    });

    if (error){
      console.error(error);
      return notify(`Invite fehlgeschlagen: ${error.message}`, "warn");
    }

    const url = new URL(location.href);
    url.searchParams.set("invite", token);
    url.searchParams.delete("room");
    url.searchParams.delete("join");

    await navigator.clipboard.writeText(url.toString());
    notify("Invite-Link kopiert âœ…", "ok");
  };
}


  startDateEl.onchange = () => { ui.startDate = startDateEl.value; renderAll(); };
  daysCountEl.onchange = () => { ui.daysCount = Number(daysCountEl.value); renderAll(); };
  hourFromEl.onchange = () => { ui.hourFrom = Number(hourFromEl.value); renderAll(); };
  hourToEl.onchange = () => { ui.hourTo = Number(hourToEl.value); renderAll(); };
  slotMinutesEl.onchange = () => { ui.slotMinutes = Number(slotMinutesEl.value); renderAll(); };
  modeEl.onchange = () => { ui.mode = modeEl.value; renderAll(); };

  // Defaults
  if (!ui.startDate) ui.startDate = ymd(new Date());
  renderAll();

// --- Invite Join ---
window.joinViaInviteIfPresent = async () => {
  const params = new URLSearchParams(location.search);
  const token = params.get("invite");
  if (!token) return;

  const user = await ensureSignedIn();
  await loadMyProfile(user);



  const { data: roomCode, error } = await supabase.rpc("redeem_invite", {
    p_token: token,
    p_display_name: me
  });

  if (error){
    console.error(error);
    return notify(`Invite ungÃ¼ltig: ${error.message}`, "warn");
  }

  room = String(roomCode).toUpperCase();
  document.getElementById("roomCode").value = room;
  if (roomInput) roomInput.value = room;

  await loadRoomState();
  await startRealtime();

  ui.mode = "me";
  renderAll();
  history.replaceState({}, "", location.pathname);
  notify("Beigetreten âœ…", "ok");
}; // âœ… HIER wird die Invite-Funktion geschlossen


// --- Auto Reconnect ---
async function autoReconnect(){
  const saved = loadSessionPrefs();
  if (!saved.room) return;

  const  user = await ensureSignedIn();
  await loadMyProfile(user);

  room = saved.room;

const roomEl = document.getElementById("roomCode");
if (roomEl) roomEl.value = room;

const nameEl = document.getElementById("myName");
if (nameEl) nameEl.value = me;

  await loadRoomState();
  await startRealtime();

  ui.mode = "me";
  renderAll();
  notify(`Wieder verbunden: ${room} âœ…`, "ok");
}


// --- Tabs + Init ---
window.addEventListener("DOMContentLoaded", async () => {

  const panelHome = document.getElementById("panelHome");
  const panelCalendar = document.getElementById("panelCalendar");
  const tabHome = document.getElementById("tabHome");
  const tabCalendar = document.getElementById("tabCalendar");

  if (!panelHome || !panelCalendar || !tabHome || !tabCalendar) {
    console.error("Tabs nicht gefunden", { panelHome, panelCalendar, tabHome, tabCalendar });
    return;
  }

  function setTab(which){
    const isHome = which === "home";
    panelHome.style.display = isHome ? "" : "none";
    panelCalendar.style.display = isHome ? "none" : "";
    tabHome.classList.toggle("active", isHome);
    tabCalendar.classList.toggle("active", !isHome);
  }

  tabHome.onclick = () => setTab("home");
  tabCalendar.onclick = () => setTab("calendar");
  setTab("home");

  const params = new URLSearchParams(location.search);
  const hasInvite = params.has("invite");

  try {
    if (hasInvite) {
      await window.joinViaInviteIfPresent();
    } else {
      await autoReconnect();
    }
  } catch (e) {
    console.error(e);
  }


  });


</script>
</body>
</html>
